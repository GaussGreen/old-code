#include "imsl_inc.h"

#if defined( _MSC_VER )
#pragma warning( once : 4101 4102 4244 4305 )
#endif
#ifdef ANSI
static VA_LIST_HACK l_int_fcn_hyper_rect (Mfloat (*f) (Mint, Mfloat *), Mint n,
                Mfloat *a, Mfloat *b, va_list argptr);
static void l_qand (Mfloat (*f) (Mint, Mfloat *), Mint *n, Mfloat *a, Mfloat *b,
                Mfloat *errabs, Mfloat *errrel, Mint *maxfcn,
                Mfloat *result, Mfloat *errest);
static void l_q3nd (Mfloat (*f) (Mint, Mfloat *), Mint *n, Mfloat *a, Mfloat *b,
                Mint *maxfcn, Mfloat *errabs, Mfloat *errrel,
                Mint *ier, Mfloat *answer, Mfloat *errest);
#else
static VA_LIST_HACK l_int_fcn_hyper_rect ();
static void l_qand ();
static void l_q3nd ();
#endif

static Mfloat lv_value;
#ifdef ANSI
Mfloat      imsl_f_int_fcn_hyper_rect (Mfloat (*fcn) (Mint, Mfloat *), Mint n,
                Mfloat *a, Mfloat *b,...)
#else
Mfloat      imsl_f_int_fcn_hyper_rect (fcn, n, a, b, va_alist)
    Mfloat      (*fcn) ();
    Mint        n;
    Mfloat     *a;
    Mfloat     *b;
va_dcl
#endif
{
    va_list     argptr;
    VA_START (argptr, b);

    E1PSH ("imsl_f_int_fcn_hyper_rect", "imsl_d_int_fcn_hyper_rect");
    lv_value = F_ZERO;
    IMSL_CALL (l_int_fcn_hyper_rect (fcn, n, a, b, argptr));
    va_end (argptr);
    E1POP ("imsl_f_int_fcn_hyper_rect", "imsl_d_int_fcn_hyper_rect");
    return lv_value;
}



#ifdef ANSI
static VA_LIST_HACK l_int_fcn_hyper_rect (Mfloat (*fcn) (Mint, Mfloat *), Mint n,
                Mfloat *a, Mfloat *b, va_list argptr)
#else
static VA_LIST_HACK l_int_fcn_hyper_rect (fcn, n, a, b, argptr)
    Mfloat      (*fcn) ();
    Mint        n;
    Mfloat     *a;
    Mfloat     *b;
    va_list     argptr;
#endif
{
    Mint        code;
    Mint        arg_number = 4;
    Mfloat      err_abs;
    Mfloat      err_rel;
    Mfloat     *err_est = NULL;
    Mfloat      temp_err_est;
    Mint        max_fcn = 1000000;

    err_abs = sqrt ( (double) imsl_amach (4));
    err_rel = sqrt ( (double) imsl_amach (4));

    code = 1;
    while (code > 0) {
	code = va_arg (argptr, Mint);
	arg_number++;
	switch (code) {
        case IMSL_ERR_ABS_ADR:
            arg_number++;
            err_abs = *(va_arg (argptr, Mfloat *));
            break;
        case IMSL_ERR_REL_ADR:
            arg_number++;
            err_rel = *(va_arg (argptr, Mfloat *));
            break;
	case IMSL_ERR_ABS:
	    arg_number++;
	    err_abs = (Mfloat) va_arg (argptr, double);
	    break;
	case IMSL_ERR_REL:
	    arg_number++;
	    err_rel = (Mfloat) va_arg (argptr, double);
	    break;
	case IMSL_ERR_EST:
	    arg_number++;
	    err_est = va_arg (argptr, Mfloat *);
	    break;
	case IMSL_MAX_EVALS:
	    arg_number++;
	    max_fcn = va_arg (argptr, Mint);
	    break;
	case 0:
	    break;
	default:
	    /* Argument number %(I2) is an unknown */
	    /* optional argument %(I1). */
	    imsl_e1sti (1, code);
	    imsl_e1sti (2, arg_number);
	    imsl_ermes (IMSL_TERMINAL, IMSL_UNKNOWN_OPTION);
	    break;
	}
    }

    if (imsl_n1rty (0))
	goto RETURN;

    if (fcn == NULL) {
	imsl_e1stl (1, "fcn");
	/* (5, 1, "The required argument %(L1) is NULL."); */
	imsl_ermes (IMSL_TERMINAL, IMSL_REQ_ARGUMENT_IS_NULL);
    }
    if (imsl_n1rty (0))
	goto RETURN;


    if (err_est == NULL)
	err_est = &temp_err_est;

    if (n <= 2) max_fcn = imsl_ii_power(256,n);

    l_qand (fcn, &n, a, b, &err_abs, &err_rel, &max_fcn,
	&lv_value, err_est);
RETURN:
    ;
    if (imsl_n1rty (0) > 3)
	lv_value = imsl_amach(6);
    return (argptr);
}

/* Structured by FOR_STRUCT, v0.2, on 09/03/90 at 11:26:24
    Options SET: fmt=t s=n
  -----------------------------------------------------------------------
    IMSL Name:  QAND/DQAND (Single/Double precision version)

    Computer:   FORC/SINGLE

    Revised:    January 1, 1986

    Purpose:    Integrate a function on a hyper-rectangle.

    Usage:      CALL QAND (F, N, A, B, ERRABS, ERRREL, MAXFCN, RESULT,
                           ERREST)

    Arguments:
       F      - User-supplied FUNCTION to be integrated.  The form is
                F(N, X), where
                N      - The dimension of the hyper-rectangle.  (Input)
                X      - The independent variable of dimension N.
                         (Input)
                F      - The value of the integrand at X.  (Output)
                F must be declared EXTERNAL in the calling program.
       N      - The dimension of the hyper-rectangle.  (Input)
                N must be less than or equal to 20.
       A      - Vector of length N.  (Input)
                Lower limits of integration.
       B      - Vector of length N.  (Input)
                Upper limits of integration.
       ERRABS - Absolute accuracy desired.  (Input)
       ERRREL - Relative accuracy desired.  (Input)
       MAXFCN - Approximate maximum number of function evaluations to
                be permitted.  (Input)
                MAXFCN cannot be greater than 256**N.
       RESULT - Estimate of the integral from A to B of F.  (Output)
                The integral of F is approximated over the N-dimensional
                hyper-rectangle A .LE. X .LE. B.
       ERREST - Estimate of the absolute value of the error.  (Output)

    Remarks:
    1. Informational errors
       Type Code
         3   1  MAXFCN was set greater than 256**N.
         4   2  The maximum number of function evaluations has been
                reached, and convergence has not been attained.

    2. If EXACT is the exact value, QAND attempts to find RESULT
       such that ABS(EXACT-RESULT) .LE. MAX(ERRABS,ERRREL*ABS(EXACT)).
       To specify only a relative error, set ERRABS to zero.  Similarly,
       to specify only an absolute error, set ERRREL to zero.

    Keywords:   Quadrature; Multiple integral

    GAMS:       H2b1a1

    Chapter:    MATH/LIBRARY Integration and Differentiation

    Copyright:  1985 by IMSL, Inc.  All Rights Reserved.

    Warranty:   IMSL warrants only that IMSL testing has been applied
                to this code.  No other warranty, expressed or implied,
                is applicable.

  -----------------------------------------------------------------------
 */
#ifdef ANSI
static void l_qand (Mfloat (*f) (Mint, Mfloat*), Mint *n, Mfloat *a, Mfloat *b,
                Mfloat *errabs, Mfloat *errrel, Mint *maxfcn,
                Mfloat *result, Mfloat *errest)
#else
static void l_qand (f, n, a, b, errabs, errrel, maxfcn, result,
                errest)
    Mfloat      (*f) ();
    Mint       *n;
    Mfloat      a[], b[], *errabs, *errrel;
    Mint       *maxfcn;
    Mfloat     *result, *errest;
#endif
{
    Mint        ier;


    imsl_e1psh ("l_qand");
    /* CHECK N */
    if ((*n <= 0) || (*n > 20)) {
	imsl_e1sti (1, *n);

	/*
	 * (5, 1, "The dimension of the hyper-rectangle n = %(i1).  N must be
	 * greater than zero and less than or equal to twenty.");
	 */
	imsl_ermes (IMSL_TERMINAL, IMSL_DIM_OF_HYPER_REC);
    }
    /* CHECK ERRABS */
    if (*errabs < F_ZERO) {
	imsl_e1str (1, *errabs);
	imsl_ermes (IMSL_TERMINAL, IMSL_ERR_ABS_SMALL);
    }
    /* CHECK ERRREL */
    if (*errrel < F_ZERO) {
	imsl_e1str (1, *errrel);
	imsl_ermes (IMSL_TERMINAL, IMSL_ERR_REL_SMALL);
    }
    /*
     * CHECK ERRABS AND ERRREL
     */
    if (*errabs == F_ZERO && *errrel == F_ZERO) {
	imsl_ermes (IMSL_TERMINAL, IMSL_ERR_TOL_ZERO);
    }
    /* CHECK ERRREL .GE. 1 */
    if (*errrel >= F_ONE) {
	imsl_e1str (1, *errrel);
	imsl_ermes (IMSL_TERMINAL, IMSL_ERR_REL_BIG);
    }
    /* CHECK MAXFCN */
    if (*maxfcn <= 0) {
	imsl_e1sti (1, *maxfcn);

	/*
	 * (5, 6, "The maximum number of function evaluations max_eval =
	 * %(i1).  It must be greater than zero.");
	 */
	imsl_ermes (IMSL_TERMINAL, IMSL_MAX_EIGEN_GT_ZERO);
    }
    if (imsl_n1rty (0) != 0)
	goto L_9000;

    /* CHECK MAXFCN .GT. 256**N */
    if (log ((Mfloat) (*maxfcn)) > *n * log (256.0)) {
	imsl_e1sti (1, *maxfcn);
	imsl_e1sti (2, *n);

	/*
	 * (3, 1, "The maximum number of function evaluations max_eval =
	 * %(i1),  n = %(i2).  MAXFCN was greater than 256**n.  It is reset
	 * to 256**n.");
	 */
	imsl_ermes (IMSL_WARNING, IMSL_MAX_EVALS_TOO_LARGE);
    }
    l_q3nd (f, n, a, b, maxfcn, errabs, errrel, &ier, result, errest);

    if (ier == 129) {
	imsl_e1sti (1, *maxfcn);

	/*
	 * (4, 2, "The maximum number of function evaluations, max_evals =
	 * %(i1), and convergence has not been attained.");
	 */
	imsl_ermes (IMSL_FATAL, IMSL_NOT_CONVERGENT);
    }
L_9000:
    ;
    imsl_e1pop ("l_qand");
    return;
}				/* end of function */
/*----------------------------------------------------------------------- */

/*  IMSL Name:  Q3ND/DQ3ND (Single/Double precision version)

    Computer:   FORC/SINGLE

    Revised:    February 7, 1989

    Purpose:    Integrate a function on a hyper-rectangle.

    Usage:      CALL Q3ND (F, N, A, B, MAXFCN, ERRABS, ERRREL, IER,
                           ANSWER, ERREST)

    Arguments:
       F      - User-supplied FUNCTION to be integrated.  The form is
                F(N, X), where
                N      - The dimension of the hyper-rectangle.  (Input)
                X      - The independent variable of dimension N.
                         (Input)
                F      - The value of the integrand at X.  (Output)
                F must be declared EXTERNAL in the calling program.
       N      - The dimension of the hyper-rectangle.  (Input)
                N must be less than or equal to 20.
       A      - Vector of length N.  (Input)
                Lower limits of integration.
       B      - Vector of length N.  (Input)
                Upper limits of integration.
       MAXFCN - Approximate maximum number of function evaluations to
                be permitted.  (Input)
       ERRABS - Absolute accuracy desired.  (Input)
       ERRREL - Relative accuracy desired.  (Input)
       IER    - Error parameter.  (Output)
       ANSWER - Estimate of the integral from A to B of F.  (Output)
                The integral of F is approximated over the N-dimensional
                hyper-rectangle A .LE. X .LE. B.
       ERREST - Estimate of the absolute value of the error.  (Output)

    Chapter:    MATH/LIBRARY Integration and Differentiation

    Copyright:  1989 by IMSL, Inc.  All Rights Reserved.

    Warranty:   IMSL warrants only that IMSL testing has been applied
                to this code.  No other warranty, expressed or implied,
                is applicable.

  -----------------------------------------------------------------------
 */

static Mfloat lv_t[] = {
    0.577350269189625764509148780502e0,
    0.861136311594052575223946488893e0,
    0.339981043584856264802665759103e0,
    0.96028985649753623168356086857e0,
    0.796666477413626739591553936476e0,
    0.525532409916328985817739049189e0,
    0.18343464249564980493947614236e0,
    0.98940093499164993259615417345e0,
    0.944575023073232576077988415535e0,
    0.865631202387831743880467897712e0,
    0.755404408355003033895101194847e0,
    0.617876244402643748446671764049e0,
    0.458016777657227386342419442984e0,
    0.281603550779258913230460501461e0,
    0.95012509837637440185319335425e-1,
    0.997263861849481563544981128665e0,
    0.985611511545268335400175044631e0,
    0.964762255587506430773811928118e0,
    0.934906075937739689170919134835e0,
    0.896321155766052123965307243719e0,
    0.849367613732569970133693004968e0,
    0.79448379596794240696309729897e0,
    0.732182118740289680387426665091e0,
    0.663044266930215200975115168663e0,
    0.587715757240762329040745476402e0,
    0.506899908932229390023747474378e0,
    0.421351276130635345364119436172e0,
    0.33186860228212764977991680573e0,
    0.239287362252137074544603209166e0,
    0.144471961582796493485186373599e0,
    0.483076656877383162348125704405e-1,
    0.999305041735772139456905624346e0,
    0.996340116771955279346924500676e0,
    0.991013371476744320739382383443e0,
    0.983336253884625956931299302157e0,
    0.973326827789910963741853507352e0,
    0.961008799652053718918614121897e0,
    0.946411374858402816062481491347e0,
    0.929569172131939575821490154559e0,
    0.910522137078502805756380668008e0,
    0.889315445995114105853404038273e0,
    0.86599939815409281976078338507e0,
    0.840629296252580362751691544696e0,
    0.813265315122797559741923338086e0,
    0.783972358943341407610220525214e0,
    0.752819907260531896611863774886e0,
    0.719881850171610826848940217832e0,
    0.685236313054233242563558371031e0,
    0.648965471254657339857761231993e0,
    0.611155355172393250248852971019e0,
    0.571895646202634034283878116659e0,
    0.531279464019894545658013903545e0,
    0.489403145707052957478526307022e0,
    0.446366017253464087984947714759e0,
    0.40227015796399160369576677126e0,
    0.357220158337668115950442615046e0,
    0.31132287199021095615751269856e0,
    0.26468716220876741637396417251e0,
    0.217423643740007084149648748989e0,
    0.169644420423992818037313629748e0,
    0.121462819296120554470376463492e0,
    0.729931217877990394495429419403e-1,
    0.243502926634244325089558428537e-1,
    0.999824887947131914473608082982e0,
    0.999077459977375895011987757684e0,
    0.997733248625514019882157443348e0,
    0.995792758534981186864161209621e0,
    0.993257112900212935303437221086e0,
    0.990127818491734383337930315472e0,
    0.986406742724586208871235519241e0,
    0.982096108435718536024765629892e0,
    0.977198491463907387165374426523e0,
    0.971716818747136580904338360183e0,
    0.965654366431965268645829026589e0,
    0.959014757853699928098918549973e0,
    0.951801961341264386217796301592e0,
    0.944020287830220182121111417901e0,
    0.935674388277916375783126754801e0,
    0.926769250878947843334624518175e0,
    0.917310198080960537036483580142e0,
    0.907302883401756813921485947489e0,
    0.896753288049158184386447397626e0,
    0.885667717345397217408292424532e0,
    0.874052796958031798695417954838e0,
    0.861915468939548460590632271595e0,
    0.849262987577968969163600128999e0,
    0.836102915060906847116875309814e0,
    0.822443116955643842464594185856e0,
    0.808291757507913660119642248581e0,
    0.793657294762193290243332946694e0,
    0.778548475506411966850494066699e0,
    0.762974330044094722779769143486e0,
    0.746944166797061981169882421435e0,
    0.730467566741908806471736942954e0,
    0.713554377683587413343859913031e0,
    0.696214708369514332385086602419e0,
    0.678458922447719259367755656705e0,
    0.660297632272646052105946834791e0,
    0.641741692562307557153524916177e0,
    0.622802193910584910761539598641e0,
    0.603490456158548624203573197531e0,
    0.583818021628763089550038857284e0,
    0.563796648226618083914430770208e0,
    0.543438302412810363444193627172e0,
    0.522755152051175478453947939496e0,
    0.501759559136144464289606293342e0,
    0.480464072404172025858275706671e0,
    0.458881419833552195449089130423e0,
    0.437024501037104162937042943417e0,
    0.414906379552275015492273879246e0,
    0.392540275033267442735648189122e0,
    0.369939555349859026616591741168e0,
    0.347117728597635508426162771972e0,
    0.324088435024413375183252279168e0,
    0.300865438877677202667154094507e0,
    0.277462620177904402806231634076e0,
    0.253893966422694320855617996496e0,
    0.230173564226659986410986577212e0,
    0.206315590902079217154058010828e0,
    0.182334305985337182410382574861e0,
    0.15824404271422493399747545214e0,
    0.134059199461187785117575317261e0,
    0.109794231127643746672974667401e0,
    0.854636405045154986364980344603e-1,
    0.610819696041395681037870235223e-1,
    0.366637909687334933302153487895e-1,
    0.122236989606157641980521196674e-1,
    0.999956050018992230734801210168e0,
    0.999768437409263186104878585512e0,
    0.999430937466261408240854181711e0,
    0.998943525843408856555026289786e0,
    0.998306266473006444055500482418e0,
    0.997519252756720827563408758638e0,
    0.99658260202338154043050442427e0,
    0.995496454481096356592647052789e0,
    0.994260972922409664962877548324e0,
    0.992876342608822117143533802322e0,
    0.991342771207583086922188510456e0,
    0.989660488745065218319243747264e0,
    0.987829747564860608916487712732e0,
    0.985850822286125956479245123868e0,
    0.983724009760315496166686117821e0,
    0.981449629025464405769303114157e0,
    0.979028021257622038824238035283e0,
    0.97645954971923415562101065175e0,
    0.973744599704370405266078557889e0,
    0.970883578480743029320923299728e0,
    0.96787691522848945490900377771e0,
    0.964725060975706430932612279685e0,
    0.961428488530732144006407468736e0,
    0.957987692411178129365790446493e0,
    0.95440318876971624176444794114e0,
    0.950675515316628276363852124712e0,
    0.946805231239127481372051725052e0,
    0.942792917117462443183076140631e0,
    0.938639174837814804981926084107e0,
    0.934344627502003094292476542768e0,
    0.929909919334005641180245550881e0,
    0.925335715583316202872730291856e0,
    0.920622702425146495505047084323e0,
    0.915771586857490384526669626561e0,
    0.910783096595065011890907203179e0,
    0.905657979960144647082681905801e0,
    0.900397005770303544771619995416e0,
    0.895000963223084577441222800002e0,
    0.889470661777610888828676580534e0,
    0.883806931033158284859826181734e0,
    0.878010620604706543986434867952e0,
    0.872082599995488289130045899567e0,
    0.866023758466554519297515431123e0,
    0.859835004903376350696173097846e0,
    0.853517267679502965073035535714e0,
    0.847071494517296207187072432785e0,
    0.840498652345762713895067997292e0,
    0.833799727155504894348443899987e0,
    0.826975723850812514289092898047e0,
    0.820027666098917067403478081822e0,
    0.812956596176431543136410438495e0,
    0.805763574812998623257389104687e0,
    0.798449681032170758782542860549e0,
    0.791016011989545994546707497985e0,
    0.783463682808183820750670206739e0,
    0.775793826411325739132052574582e0,
    0.768007593352445635975890600729e0,
    0.76010615164265545494190679754e0,
    0.752090686575492059587529728368e0,
    0.743962400549111568455683121575e0,
    0.735722512885917834620372850235e0,
    0.727372259649652126586894398148e0,
    0.718912893459971448372639850248e0,
    0.710345683304543313394566316975e0,
    0.701671914348685159406083549883e0,
    0.692892887742576960105341606356e0,
    0.684009920426075953124877107353e0,
    0.675024344931162763855918731538e0,
    0.665937509182048559906408413877e0,
    0.656750776292973221887500235396e0,
    0.647465524363724862617016228829e0,
    0.638083146272911368668688583383e0,
    0.628605049469014975432209867767e0,
    0.619032655759261219430967634291e0,
    0.60936740109633393952231084466e0,
    0.599610735362968321730388226636e0,
    0.589764122154454300785786143912e0,
    0.579829038559082944921831712119e0,
    0.569806974936568759057667535465e0,
    0.559699434694481145136907431121e0,
    0.549507934062718557042426884388e0,
    0.539234001866059181127936244075e0,
    0.528879179294822261951476413964e0,
    0.518445019673674476221661709631e0,
    0.507933088228616036231924919033e0,
    0.497344961852181477119512385353e0,
    0.486682228866890350103621419411e0,
    0.47594648878698330639073752309e0,
    0.465139352078479313645570450481e0,
    0.454262439917589998774455201094e0,
    0.44331738394752735721692575276e0,
    0.432305826033741309953441072147e0,
    0.421229418017623824976812371852e0,
    0.410089821468716550006433574842e0,
    0.398888707435459127713463212761e0,
    0.387627756194515583637984588084e0,
    0.376308656998716390283055712921e0,
    0.36493310782365401853346488052e0,
    0.353502815112969989537790153038e0,
    0.342019493522371636480729674158e0,
    0.330484865662416976229187036473e0,
    0.318900661840106275631683382156e0,
    0.30726861979931907625861025422e0,
    0.295590484460135614563786795633e0,
    0.283868007657081741799765765171e0,
    0.272102947876336609505244723296e0,
    0.260297069991942541978560859024e0,
    0.24845214500105666683324268886e0,
    0.236569949758284018477508408869e0,
    0.224652266709131967147878316315e0,
    0.212700883622625957937040153463e0,
    0.200717593323126670068000730614e0,
    0.188704193421388826461503572234e0,
    0.176662486044901997403721815255e0,
    0.164594277567553849829284507555e0,
    0.152501378338656395374606840669e0,
    0.140385602411375885913024875641e0,
    0.128248767270607094742049596212e0,
    0.116092693560332804940734863887e0,
    0.103919204810509403639196896559e0,
    0.917301271635195520311456005978e-1,
    0.795272891002329659032270684566e-1,
    0.67312521165716400242290288817e-1,
    0.550876556946339841045614164248e-1,
    0.42854526536379098381242288682e-1,
    0.306149687799790293662785813214e-1,
    0.183708184788136651179262920605e-1,
    0.612391237518952950117016496227e-2
};

static Mfloat lv_w[] = {
    0.1e1,
    0.347854845137453857373063949222e0,
    0.652145154862546142626936050778e0,
    0.10122853629037625915253135431e0,
    0.222381034453374470544355994426e0,
    0.313706645877887287337962201987e0,
    0.362683783378361982965150449277e0,
    0.27152459411754094851780572456e-1,
    0.622535239386478928628438369944e-1,
    0.951585116824927848099251076023e-1,
    0.124628971255533872052476282192e0,
    0.149595988816576732081501730548e0,
    0.16915651939500253818931207903e0,
    0.182603415044923588866763667969e0,
    0.189450610455068496285396723208e0,
    0.701861000947009660040706373885e-2,
    0.162743947309056706051705622064e-1,
    0.253920653092620594557525897892e-1,
    0.342738629130214331026877322524e-1,
    0.428358980222266806568786466061e-1,
    0.509980592623761761961632446895e-1,
    0.586840934785355471452836373002e-1,
    0.658222227763618468376500637069e-1,
    0.723457941088485062253993564785e-1,
    0.781938957870703064717409188283e-1,
    0.833119242269467552221990746044e-1,
    0.876520930044038111427714627518e-1,
    0.911738786957638847128685771116e-1,
    0.938443990808045656391802376681e-1,
    0.956387200792748594190820022041e-1,
    0.965400885147278005667648300636e-1,
    0.178328072169643294729607914497e-2,
    0.414703326056246763528753572855e-2,
    0.650445796897836285611736039998e-2,
    0.884675982636394772303091465973e-2,
    0.111681394601311288185904930192e-1,
    0.13463047896718642598060766686e-1,
    0.157260304760247193219659952975e-1,
    0.179517157756973430850453020011e-1,
    0.201348231535302093723403167285e-1,
    0.222701738083832541592983303842e-1,
    0.243527025687108733381775504091e-1,
    0.263774697150546586716917926252e-1,
    0.283396726142594832275113052002e-1,
    0.302346570724024788679740598196e-1,
    0.320579283548515535854675043479e-1,
    0.338051618371416093915654821107e-1,
    0.354722132568823838106931467153e-1,
    0.370551285402400460404151018096e-1,
    0.385501531786156291289624969468e-1,
    0.399537411327203413866569261283e-1,
    0.412625632426235286101562974736e-1,
    0.424735151236535890073397679088e-1,
    0.435837245293234533768278609737e-1,
    0.44590558163756563060134710031e-1,
    0.454916279274181444797709969713e-1,
    0.462847965813144172959532492323e-1,
    0.469681828162100173253262857546e-1,
    0.475401657148303086622822069442e-1,
    0.479993885964583077281261798714e-1,
    0.48344762234802957169769527158e-1,
    0.48575467441503426934799066784e-1,
    0.486909570091397203833653907348e-1,
    0.449380960292090376394292239989e-3,
    0.104581267934034877931285160011e-2,
    0.16425030186690295387908755948e-2,
    0.223828843096261874362205427272e-2,
    0.283275147145799109528573464682e-2,
    0.342552604091021577433778466013e-2,
    0.40162549837386423131943434863e-2,
    0.460458425670295511829054198029e-2,
    0.519016183267633020507076713485e-2,
    0.577263754286569858933461762607e-2,
    0.635166316170718878721432782623e-2,
    0.692689256689881356342667036033e-2,
    0.749798192563472868767196268847e-2,
    0.806458989048605797292859869786e-2,
    0.862637779861674970497884378197e-2,
    0.918300987166087433447874368843e-2,
    0.973415341500680586354826609356e-2,
    0.102794790158321571332153403264e-1,
    0.108186607395030762476596462775e-1,
    0.113513763240804166932816684525e-1,
    0.118773073727402795758911069256e-1,
    0.123961395439509229688217281973e-1,
    0.129075627392673472204428340039e-1,
    0.134112712886163323144889516162e-1,
    0.139069641329519852442880073956e-1,
    0.143943450041668461768238920085e-1,
    0.148731226021473142523854985201e-1,
    0.153430107688651440859908537414e-1,
    0.158037286593993468589656316874e-1,
    0.162550009097851870516574564771e-1,
    0.166965578015892045890915079538e-1,
    0.171281354231113768306809876189e-1,
    0.175494758271177046487069256344e-1,
    0.17960327185008685940196927525e-1,
    0.183604439373313432212892909913e-1,
    0.187495869405447086509195484739e-1,
    0.191275236099509454865185316678e-1,
    0.194940280587066028230219186812e-1,
    0.198488812328308622199444132649e-1,
    0.201918710421300411806731584061e-1,
    0.205227924869600694322849677882e-1,
    0.208414477807511491135839484229e-1,
    0.211476464682213485370195351804e-1,
    0.21441205539208460137111853878e-1,
    0.217219495380520753752609577676e-1,
    0.219897106684604914341221065992e-1,
    0.222443288937997651046291336072e-1,
    0.224856520327449668718246039406e-1,
    0.227135358502364613097126359229e-1,
    0.229278441436868469204109872093e-1,
    0.231284488243870278792979024028e-1,
    0.233152299940627601224156712728e-1,
    0.234880760165359131530252732818e-1,
    0.236468835844476151436513923029e-1,
    0.237915577810034006387807098854e-1,
    0.239220121367034556724504088171e-1,
    0.240381686810240526375873168196e-1,
    0.241399579890192849977166538905e-1,
    0.242273192228152481200933084418e-1,
    0.243002001679718653234426063638e-1,
    0.243585572646906258532685202463e-1,
    0.244023556338495820932979896942e-1,
    0.244315690978500450548485614286e-1,
    0.244461801962625182113258526106e-1,
    0.11278901782227217551253887725e-3,
    0.2625349442964459062874575625e-3,
    0.412463254426176328432185837736e-3,
    0.562348954031409802815236747593e-3,
    0.712154163473320666908989151123e-3,
    0.861853701420089037814093416251e-3,
    0.101142439320844045260581284143e-2,
    0.116084355756772472397059811346e-2,
    0.131008868190250445783168042706e-2,
    0.145913733331073320108838649958e-2,
    0.160796713074932724244993956898e-2,
    0.175655573633072999360691452952e-2,
    0.190488085349971840441914117458e-2,
    0.20529202279661431745487818492e-2,
    0.220065164983991049968488341886e-2,
    0.234805295632731201700646090869e-2,
    0.24951020347037068508395354372e-2,
    0.264177682542749056412082925158e-2,
    0.278805532532770688057476107625e-2,
    0.293391559082971664601232541422e-2,
    0.307933574119933758320535283159e-2,
    0.322429396179419815701071342688e-2,
    0.336876850731555101201910624893e-2,
    0.351273770505630733097105498443e-2,
    0.365617995814250216938924130522e-2,
    0.379907374876625799811701920824e-2,
    0.3941397641408833627729034984e-2,
    0.408313028605266840859977592119e-2,
    0.422425042138153627235650490599e-2,
    0.436473687796805668156842006212e-2,
    0.450456858144789706864179231592e-2,
    0.464372455568006031397909235247e-2,
    0.478218392589269137293173404476e-2,
    0.491992592181386566955877656549e-2,
    0.505692988078684238755781607621e-2,
    0.519317525086928093032875362964e-2,
    0.532864159391593031708111147879e-2,
    0.546330858864431027757053185663e-2,
    0.559715603368291007755144525719e-2,
    0.573016385060143717738441755539e-2,
    0.586231208692265306066159880109e-2,
    0.599358091911533822112769687036e-2,
    0.61239506555679325423890811866e-2,
    0.625340173954240127206364597525e-2,
    0.638191475210788057037516427494e-2,
    0.650947041505366026780989995138e-2,
    0.663604959378106504459003835507e-2,
    0.676163330017379878092786110788e-2,
    0.688620269544632034671332377453e-2,
    0.700973909296982262123443619368e-2,
    0.713222396107539007167242298552e-2,
    0.725363892583391378382913721418e-2,
    0.737396577381234643757244069469e-2,
    0.749318645480588335859976113332e-2,
    0.761128308454565946161871961804e-2,
    0.772823794738155563111019495784e-2,
    0.784403349893971186681031615122e-2,
    0.795865236875434835361316122694e-2,
    0.807207736287349950094697480414e-2,
    0.818429146643826993561976100372e-2,
    0.829527784623522542517141255288e-2,
    0.840501985322153575618030169816e-2,
    0.85135010250224906938383547897e-2,
    0.862070508840101430536883841018e-2,
    0.872661596169880714033663221736e-2,
    0.883121775724875002531827268512e-2,
    0.893449478375820754840841708495e-2,
    0.903643154866287368022777557239e-2,
    0.913701276045080640200047221868e-2,
    0.923622333095630268737871671386e-2,
    0.933404837762326971246601448636e-2,
    0.943047322573775274735276448237e-2,
    0.952548341062928481182968575443e-2,
    0.961906467984072785716216440052e-2,
    0.971120299526627996424967049581e-2,
    0.980188453525732782549880024998e-2,
    0.989109569669582860263068380918e-2,
    0.997882309703491012473394949458e-2,
    0.100650535763063833094609789296e-1,
    0.101497741990948656546340660419e-1,
    0.102329722564782196569548571605e-1,
    0.103146352679340150682607139973e-1,
    0.103947509832117289971017252053e-1,
    0.104733073841704030035695669267e-1,
    0.10550292686581481517533575536e-1,
    0.106256953418965611339616818014e-1,
    0.106995040389797856030482005827e-1,
    0.107717077058046266366536319272e-1,
    0.108422955111147959952934770584e-1,
    0.109112568660490397007968477876e-1,
    0.109785814257295706379882034477e-1,
    0.110442590908139012635175710437e-1,
    0.111082800090098436304608154507e-1,
    0.111706345765534494627108819383e-1,
    0.112313134396496685726568020834e-1,
    0.112903074958755095083675941213e-1,
    0.113476078955454919416257142968e-1,
    0.114032060430391859648470595523e-1,
    0.114570935980906391523343922981e-1,
    0.115092624770394979585863924387e-1,
    0.115597048540436357726686569503e-1,
    0.116084131622531057220847066772e-1,
    0.116553800949452421212989397303e-1,
    0.117005986066207402881898233592e-1,
    0.117440619140605503053767327586e-1,
    0.117857634973434261816901176269e-1,
    0.118256971008239777711607379581e-1,
    0.118638567340710787319045729076e-1,
    0.119002366727664897542872042371e-1,
    0.119348314595635622558732016965e-1,
    0.119676359049058937290072826699e-1,
    0.119986450878058119345367100708e-1,
    0.120278543565825711612675334976e-1,
    0.120552593295601498143470853274e-1,
    0.120808558957245446559751839755e-1,
    0.121046402153404630977578297364e-1,
    0.121266087205273210347184922045e-1,
    0.121467581157944598155598376642e-1,
    0.121650853785355020613072918389e-1,
    0.12181587759481772174047585032e-1,
    0.121962627831147135181809741965e-1,
    0.122091082480372404075140943707e-1,
    0.122201222273039691917087372273e-1,
    0.122293030687102789041462660832e-1,
    0.122366493950401581092425747674e-1,
    0.122421601042728007697280832602e-1,
    0.122458343697479201424638575499e-1,
    0.122476716402897559040703264897e-1
};
#ifdef ANSI
static void l_q3nd (Mfloat (*f) (Mint, Mfloat*), Mint *n, Mfloat *a, Mfloat *b,
                Mint *maxfcn, Mfloat *errabs, Mfloat *errrel,
                Mint *ier, Mfloat *answer, Mfloat *errest)
#else
static void l_q3nd (f, n, a, b, maxfcn, errabs, errrel, ier, answer, errest)
    Mfloat      (*f) ();
    Mint       *n;
    Mfloat      a[], b[];
    Mint       *maxfcn;
    Mfloat     *errabs, *errrel;
    Mint       *ier;
    Mfloat     *answer, *errest;
#endif
{
    Mint        i, ires, j, m[20], nlim, nn, nn2, nn2i, nni;
    Mfloat      bma[20], bpa[20], bwt, result[8], temp, tint, tt[256], wt,
                ww[256], x[20];
    *ier = 0;
    *answer = F_ZERO;
    bwt = F_ONE;
    for (i = 1; i <= *n; i++) {
	bma[i - 1] = (b[i - 1] - a[i - 1]) * F_HALF;
	bpa[i - 1] = (b[i - 1] + a[i - 1]) * F_HALF;
	bwt *= bma[i - 1];
    }
    nlim = 8;
    /*
     * USE 2**IRES POINT GAUSSIAN FORMULA IN EACH DIMENSION
     */
    for (ires = 1; ires <= nlim; ires++) {
	nn = imsl_ii_power (2, ires);
	if (*n * log (F_TWO * nn) - log (imsl_fi_power (F_TWO, *n) - F_ONE) > log ((Mfloat) (*maxfcn)))
	    goto L_90;
	nn2 = nn / 2;
	for (i = 1; i <= nn2; i++) {
	    nn2i = nn2 - 1 + i;
	    nni = nn + 1 - i;
	    tt[i - 1] = -lv_t[nn2i - 1];
	    tt[nni - 1] = -tt[i - 1];
	    ww[i - 1] = lv_w[nn2i - 1];
	    ww[nni - 1] = ww[i - 1];
	}
	iset (*n, 1, m, 1);
	m[0] = 0;
	tint = F_ZERO;
	/*
	 * THE FOLLOWING IS EQUIVALENT TO N NESTED DO-LOOPS
	 */
L_30:
	m[0] += 1;
	if (*n == 1)
	    goto L_50;
	for (i = 2; i <= *n; i++) {
	    if (m[i - 2] <= nn)
		goto L_40;
	    m[i - 2] = 1;
	    m[i - 1] += 1;
    L_40:
	    ;
	}
L_50:
	if (m[*n - 1] > nn)
	    goto L_70;
	wt = bwt;
	for (i = 1; i <= *n; i++) {
	    j = m[i - 1];
	    wt *= ww[j - 1];
	    x[i - 1] = bpa[i - 1] + tt[j - 1] * bma[i - 1];
	}
	imsl_e1usr ("ON");
	temp = (*f) (*n, x);
	imsl_e1usr ("OFF");
	tint += temp * wt;
	goto L_30;
L_70:
	result[ires - 1] = tint;
	*answer = tint;
	if (ires == 1)
	    goto L_80;
	/*
	 * COMPARE LAST TWO ESTIMATES TO CHECK FOR CONVERGENCE
	 */
	*errest = fabs (result[ires - 1] - result[ires - 2]);
	if (*errest <= imsl_f_max (*errabs, *errrel * fabs (result[ires - 1])))
	    goto L_9000;
L_80:
	;
    }
L_90:
    *ier = 129;
L_9000:
    ;
    return;
}				/* end of function */
